<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.bbs.dao.PostDao">

    <select id="findAll" resultType="Post">
       (SELECT postId,postTitle,postContent,postScore,postUserId,postPhoto,highlight,postTime,postType,top,postCategoryId
  FROM `comment`,`post`
  WHERE commentPostId=postId
  GROUP BY commentPostId
  ORDER BY COUNT(commentId) DESC limit 999999)
  union
  (SELECT *
  FROM `post` WHERE postId not in(
  SELECT commentPostId
  FROM `comment`
  ))

    </select>

    <select id="findByCategoryId" resultType="Post">
        (SELECT postId,postTitle,postContent,postScore,postUserId,postPhoto,highlight,postTime,postType,top,postCategoryId
FROM `comment`,`post`
WHERE commentPostId=postId and postCategoryId=#{postCategoryId}
GROUP BY commentPostId
ORDER BY COUNT(commentId) DESC limit 999999)
union
(SELECT *
FROM `post` WHERE postCategoryId=#{postCategoryId} and postId not in(
SELECT commentPostId
FROM `comment`
))

    </select>

    <select id="findPostByPostId" resultType="Post">
        (SELECT postId,postTitle,postContent,postScore,postUserId,postPhoto,highlight,postTime,postType,top,postCategoryId
FROM `comment`,`post`
WHERE commentPostId=postId and postId=#{postId}
GROUP BY commentPostId
ORDER BY COUNT(commentId) DESC limit 999999)
union
(SELECT *
FROM `post` WHERE postId=#{postId} and postId not in(
SELECT commentPostId
FROM `comment`
))
    </select>

    <select id="getAllComments" resultType="Comment">
        (select commentId,commentUserId,commentToId,commentToUserId,commentContent,commentPostId,commentTime
        FROM `comment`
        WHERE commentPostId=#{postId}
        )
    </select>

    <delete id="deletePostByPostId">
        delete from post where postId=#{postId}
    </delete>
    <update id="toTop">
        UPDATE post set top=1 WHERE postId=#{postId}
    </update>
    <update id="toHighlight">
        UPDATE post set highlight=1 WHERE postId=#{postId}
    </update>

    <select id="countCommentsNum" resultType="int">
        SELECT COUNT(commentPostId) from `comment` WHERE commentPostId=#{postId}
    </select>
    <select id="getUserName" resultType="String">
        SELECT userName FROM `user` WHERE userId=#{userId}
    </select>

    <select id="getPostUserHeader" resultType="String">
        SELECT profilePhoto FROM `user` WHERE userId=#{userId}
    </select>

    <insert id="createPost">
        INSERT into `post`(postTitle,postContent,postScore,postUserId,postPhoto,highlight,postTime,postType,top,postCategoryId)
                  VALUES(#{postTitle},#{postContent},${postScore},${postUserId},#{postPhoto},${highlight},#{postTime},${postType},${top},${postCategoryId})
    </insert>
    <select id="countTopPost" resultType="int">
        select count(*) from post where top = 1
    </select>
    <select id="countHightlightPost" resultType="int">
        select count(*) from post where highlight = 1
    </select>
    <select id="countDemandPost" resultType="int">
        select count(*) from post where postType = 1
    </select>
    <select id="countNormalPost" resultType="int">
        select count(*) from post where postType = 0 and top = 0 and highlight = 0
    </select>
    <select id="findByPostUserId" resultType="Post">
        (SELECT postId,postTitle,postContent,postScore,postUserId,postPhoto,highlight,postTime,postType,top,postCategoryId
  FROM `comment`,`post`
  WHERE commentPostId=postId and postUserId=${postUserId}
  GROUP BY commentPostId
  ORDER BY COUNT(commentId) DESC limit 999999)
  union
  (SELECT *
  FROM `post` WHERE postId not in(
  SELECT commentPostId
  FROM `comment`
  ))
    </select>


</mapper>
